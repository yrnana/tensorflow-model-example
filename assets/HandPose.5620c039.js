import{bR as an,T as A,g as x,p as un,q as cn,u as hn,t as dn,d as N,f as L,o as z,e as C,m as T,h as G,l as fn,w as D,bQ as K,z as B,k as q,n as ln,i as S,r as I}from"./vendor.a4162548.js";import{l as U}from"./graph_model.6c4c3382.js";import{a as pn,d as mn,s as vn,V as gn}from"./canvas.77fa6c83.js";import{a as Pn,j as Q}from"./index.65c1c8a9.js";/**
    * @license
    * Copyright 2021 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */function k(r,t,o,n){return new(o||(o=Promise))(function(e,a){function i(f){try{h(n.next(f))}catch(s){a(s)}}function u(f){try{h(n.throw(f))}catch(s){a(s)}}function h(f){var s;f.done?e(f.value):(s=f.value,s instanceof o?s:new o(function(l){l(s)})).then(i,u)}h((n=n.apply(r,t||[])).next())})}function y(r,t){var o,n,e,a,i={label:0,sent:function(){if(1&e[0])throw e[1];return e[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function u(h){return function(f){return function(s){if(o)throw new TypeError("Generator is already executing.");for(;i;)try{if(o=1,n&&(e=2&s[0]?n.return:s[0]?n.throw||((e=n.return)&&e.call(n),0):n.next)&&!(e=e.call(n,s[1])).done)return e;switch(n=0,e&&(s=[2&s[0],e.value]),s[0]){case 0:case 1:e=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(e=i.trys,!((e=e.length>0&&e[e.length-1])||s[0]!==6&&s[0]!==2)){i=0;continue}if(s[0]===3&&(!e||s[1]>e[0]&&s[1]<e[3])){i.label=s[1];break}if(s[0]===6&&i.label<e[1]){i.label=e[1],e=s;break}if(e&&i.label<e[2]){i.label=e[2],i.ops.push(s);break}e[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(r,i)}catch(l){s=[6,l],n=0}finally{o=e=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([h,f])}}}function j(r){return[Math.abs(r.endPoint[0]-r.startPoint[0]),Math.abs(r.endPoint[1]-r.startPoint[1])]}function O(r){return[r.startPoint[0]+(r.endPoint[0]-r.startPoint[0])/2,r.startPoint[1]+(r.endPoint[1]-r.startPoint[1])/2]}function J(r,t){t===void 0&&(t=1.5);var o=O(r),n=j(r),e=[t*n[0]/2,t*n[1]/2];return{startPoint:[o[0]-e[0],o[1]-e[1]],endPoint:[o[0]+e[0],o[1]+e[1]],palmLandmarks:r.palmLandmarks}}function X(r){var t=O(r),o=j(r),n=Math.max.apply(Math,o)/2;return{startPoint:[t[0]-n,t[1]-n],endPoint:[t[0]+n,t[1]+n],palmLandmarks:r.palmLandmarks}}function Y(r,t){var o=[r.endPoint[0]-r.startPoint[0],r.endPoint[1]-r.startPoint[1]],n=[o[0]*t[0],o[1]*t[1]];return{startPoint:[r.startPoint[0]+n[0],r.startPoint[1]+n[1]],endPoint:[r.endPoint[0]+n[0],r.endPoint[1]+n[1]],palmLandmarks:r.palmLandmarks}}var bn=function(){function r(t,o,n,e,a,i){this.model=t,this.width=o,this.height=n,this.iouThreshold=a,this.scoreThreshold=i,this.anchors=e.map(function(u){return[u.x_center,u.y_center]}),this.anchorsTensor=dn(this.anchors),this.inputSizeTensor=N([o,n]),this.doubleInputSizeTensor=N([2*o,2*n])}return r.prototype.normalizeBoxes=function(t){var o=this;return x(function(){var n=L(t,[0,0],[-1,2]),e=L(t,[0,2],[-1,2]),a=z(C(n,o.inputSizeTensor),o.anchorsTensor),i=C(e,o.doubleInputSizeTensor),u=T(G(a,i),o.inputSizeTensor),h=T(z(a,i),o.inputSizeTensor);return fn([u,h],1)})},r.prototype.normalizeLandmarks=function(t,o){var n=this;return x(function(){var e=z(C(D(t,[-1,7,2]),n.inputSizeTensor),n.anchors[o]);return T(e,n.inputSizeTensor)})},r.prototype.getBoundingBoxes=function(t){return k(this,void 0,void 0,function(){var o,n,e,a,i,u,h,f,s,l,d,c,p,v,g,P=this;return y(this,function(m){switch(m.label){case 0:return o=x(function(){return T(G(t,.5),2)}),K()==="webgl"?(e=B().get("WEBGL_PACK_DEPTHWISECONV"),B().set("WEBGL_PACK_DEPTHWISECONV",!0),n=this.model.predict(o),B().set("WEBGL_PACK_DEPTHWISECONV",e)):n=this.model.predict(o),a=q(n),i=x(function(){return q(ln(L(a,[0,0],[-1,1])))}),u=L(a,[0,1],[-1,4]),h=this.normalizeBoxes(u),f=console.warn,console.warn=function(){},s=S.nonMaxSuppression(h,i,1,this.iouThreshold,this.scoreThreshold),console.warn=f,[4,s.array()];case 1:return l=m.sent(),d=[o,n,s,a,h,u,i],l.length===0?(d.forEach(function(b){return b.dispose()}),[2,null]):(c=l[0],p=L(h,[c,0],[1,-1]),v=L(a,[c,5],[1,14]),g=x(function(){return D(P.normalizeLandmarks(v,c),[-1,2])}),d.push(v),d.forEach(function(b){return b.dispose()}),[2,{boxes:p,palmLandmarks:g}])}})})},r.prototype.estimateHandBounds=function(t){return k(this,void 0,void 0,function(){var o,n,e,a,i,u,h,f,s=this;return y(this,function(l){switch(l.label){case 0:return o=t.shape[1],n=t.shape[2],e=x(function(){return C(S.resizeBilinear(t,[s.width,s.height]),255)}),[4,this.getBoundingBoxes(e)];case 1:return(a=l.sent())===null?(e.dispose(),[2,null]):(i=a.boxes.arraySync(),u=i[0].slice(0,2),h=i[0].slice(2,4),f=a.palmLandmarks.arraySync(),e.dispose(),a.boxes.dispose(),a.palmLandmarks.dispose(),[2,(d={startPoint:u,endPoint:h,palmLandmarks:f},c=[n/this.width,o/this.height],{startPoint:[d.startPoint[0]*c[0],d.startPoint[1]*c[1]],endPoint:[d.endPoint[0]*c[0],d.endPoint[1]*c[1]],palmLandmarks:d.palmLandmarks.map(function(p){return[p[0]*c[0],p[1]*c[1]]})})])}var d,c})})},r}(),_={thumb:[1,2,3,4],indexFinger:[5,6,7,8],middleFinger:[9,10,11,12],ringFinger:[13,14,15,16],pinky:[17,18,19,20],palmBase:[0]};function kn(r,t){var o,n=Math.PI/2-Math.atan2(-(t[1]-r[1]),t[0]-r[0]);return(o=n)-2*Math.PI*Math.floor((o+Math.PI)/(2*Math.PI))}var Z=function(r,t){return[[1,0,r],[0,1,t],[0,0,1]]};function w(r,t){for(var o=0,n=0;n<r.length;n++)o+=r[n]*t[n];return o}function yn(r,t){for(var o=[],n=0;n<r.length;n++)o.push(r[n][t]);return o}function $(r,t){for(var o=[],n=r.length,e=0;e<n;e++){o.push([]);for(var a=0;a<n;a++)o[e].push(w(r[e],yn(t,a)))}return o}function nn(r,t){var o=Math.cos(r),n=Math.sin(r),e=[[o,-n,0],[n,o,0],[0,0,1]],a=$(Z(t[0],t[1]),e);return $(a,Z(-t[0],-t[1]))}function tn(r,t){return[w(r,t[0]),w(r,t[1])]}var xn=[0,-.4],wn=[0,-.1],en=[0,5,9,13,17,1,2],Ln=function(){function r(t,o,n,e,a,i){this.boundingBoxDetector=t,this.meshDetector=o,this.meshWidth=n,this.meshHeight=e,this.maxContinuousChecks=a,this.detectionConfidence=i,this.regionsOfInterest=[],this.runsWithoutHandDetector=0,this.maxHandsNumber=1}return r.prototype.getBoxForPalmLandmarks=function(t,o){var n=t.map(function(e){return tn(e.concat([1]),o)});return J(X(Y(this.calculateLandmarksBoundingBox(n),xn)),3)},r.prototype.getBoxForHandLandmarks=function(t){for(var o=J(X(Y(this.calculateLandmarksBoundingBox(t),wn)),1.65),n=[],e=0;e<en.length;e++)n.push(t[en[e]].slice(0,2));return o.palmLandmarks=n,o},r.prototype.transformRawCoords=function(t,o,n,e){var a,i,u,h,f=this,s=j(o),l=[s[0]/this.meshWidth,s[1]/this.meshHeight],d=t.map(function(m){return[l[0]*(m[0]-f.meshWidth/2),l[1]*(m[1]-f.meshHeight/2),m[2]]}),c=nn(n,[0,0]),p=d.map(function(m){return tn(m,c).concat([m[2]])}),v=(i=[[(a=e)[0][0],a[1][0]],[a[0][1],a[1][1]]],u=[a[0][2],a[1][2]],h=[-w(i[0],u),-w(i[1],u)],[i[0].concat(h[0]),i[1].concat(h[1]),[0,0,1]]),g=O(o).concat([1]),P=[w(g,v[0]),w(g,v[1])];return p.map(function(m){return[m[0]+P[0],m[1]+P[1],m[2]]})},r.prototype.estimateHand=function(t){return k(this,void 0,void 0,function(){var o,n,e,a,i,u,h,f,s,l,d,c,p,v,g,P,m,b,E,H;return y(this,function(W){switch(W.label){case 0:return(o=this.shouldUpdateRegionsOfInterest())!==!0?[3,2]:[4,this.boundingBoxDetector.estimateHandBounds(t)];case 1:return(n=W.sent())===null?(t.dispose(),this.regionsOfInterest=[],[2,null]):(this.updateRegionsOfInterest(n,!0),this.runsWithoutHandDetector=0,[3,3]);case 2:this.runsWithoutHandDetector++,W.label=3;case 3:return e=this.regionsOfInterest[0],a=kn(e.palmLandmarks[0],e.palmLandmarks[2]),i=O(e),u=[i[0]/t.shape[2],i[1]/t.shape[1]],h=S.rotateWithOffset(t,a,0,u),f=nn(-a,i),s=o===!0?this.getBoxForPalmLandmarks(e.palmLandmarks,f):e,l=function(M,R,on){var F=R.shape[1],V=R.shape[2],sn=[[M.startPoint[1]/F,M.startPoint[0]/V,M.endPoint[1]/F,M.endPoint[0]/V]];return S.cropAndResize(R,sn,[0],on)}(s,h,[this.meshWidth,this.meshHeight]),d=C(l,255),l.dispose(),h.dispose(),K()==="webgl"?(p=B().get("WEBGL_PACK_DEPTHWISECONV"),B().set("WEBGL_PACK_DEPTHWISECONV",!0),c=this.meshDetector.predict(d),B().set("WEBGL_PACK_DEPTHWISECONV",p)):c=this.meshDetector.predict(d),v=c[0],g=c[1],d.dispose(),P=v.dataSync()[0],v.dispose(),P<this.detectionConfidence?(g.dispose(),this.regionsOfInterest=[],[2,null]):(m=D(g,[-1,3]),b=m.arraySync(),g.dispose(),m.dispose(),E=this.transformRawCoords(b,s,a,f),H=this.getBoxForHandLandmarks(E),this.updateRegionsOfInterest(H,!1),[2,{landmarks:E,handInViewConfidence:P,boundingBox:{topLeft:H.startPoint,bottomRight:H.endPoint}}])}})})},r.prototype.calculateLandmarksBoundingBox=function(t){var o=t.map(function(e){return e[0]}),n=t.map(function(e){return e[1]});return{startPoint:[Math.min.apply(Math,o),Math.min.apply(Math,n)],endPoint:[Math.max.apply(Math,o),Math.max.apply(Math,n)]}},r.prototype.updateRegionsOfInterest=function(t,o){if(o)this.regionsOfInterest=[t];else{var n=this.regionsOfInterest[0],e=0;if(n!=null&&n.startPoint!=null){var a=t.startPoint,i=a[0],u=a[1],h=t.endPoint,f=h[0],s=h[1],l=n.startPoint,d=l[0],c=l[1],p=n.endPoint,v=p[0],g=p[1],P=Math.max(i,d),m=Math.max(u,c),b=(Math.min(f,v)-P)*(Math.min(s,g)-m);e=b/((f-i)*(s-u)+(v-d)*(g-u)-b)}this.regionsOfInterest[0]=e>.8?n:t}},r.prototype.shouldUpdateRegionsOfInterest=function(){return this.regionsOfInterest.length!==this.maxHandsNumber||this.runsWithoutHandDetector>=this.maxContinuousChecks},r}();function Bn(){return k(this,void 0,void 0,function(){return y(this,function(r){return[2,U("https://tfhub.dev/mediapipe/tfjs-model/handdetector/1/default/1",{fromTFHub:!0})]})})}function Cn(){return k(this,void 0,void 0,function(){return y(this,function(r){return[2,U("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1",{fromTFHub:!0})]})})}function In(){return k(this,void 0,void 0,function(){return y(this,function(r){return[2,an("https://tfhub.dev/mediapipe/tfjs-model/handskeleton/1/default/1/anchors.json?tfjs-format=file").then(function(t){return t.json()})]})})}function Hn(r){var t=r===void 0?{}:r,o=t.maxContinuousChecks,n=o===void 0?1/0:o,e=t.detectionConfidence,a=e===void 0?.8:e,i=t.iouThreshold,u=i===void 0?.3:i,h=t.scoreThreshold,f=h===void 0?.5:h;return k(this,void 0,void 0,function(){var s,l,d,c,p,v;return y(this,function(g){switch(g.label){case 0:return[4,Promise.all([In(),Bn(),Cn()])];case 1:return s=g.sent(),l=s[0],d=s[1],c=s[2],p=new bn(d,256,256,l,u,f),v=new Ln(p,c,256,256,n,a),[2,new Mn(v)]}})})}var Mn=function(){function r(t){this.pipeline=t}return r.getAnnotations=function(){return _},r.prototype.estimateHands=function(t,o){return o===void 0&&(o=!1),k(this,void 0,void 0,function(){var n,e,a,i,u,h,f,s,l;return y(this,function(d){switch(d.label){case 0:return n=function(c){return c instanceof A?[c.shape[0],c.shape[1]]:[c.height,c.width]}(t),e=n[1],a=x(function(){return t instanceof A||(t=un(t)),cn(hn(t,"float32"))}),[4,this.pipeline.estimateHand(a)];case 1:if(i=d.sent(),a.dispose(),i===null)return[2,[]];for(u=i,o===!0&&(u=function(c,p){var v=c.handInViewConfidence,g=c.landmarks,P=c.boundingBox;return{handInViewConfidence:v,landmarks:g.map(function(m){return[p-1-m[0],m[1],m[2]]}),boundingBox:{topLeft:[p-1-P.topLeft[0],P.topLeft[1]],bottomRight:[p-1-P.bottomRight[0],P.bottomRight[1]]}}}(i,e)),h={},f=0,s=Object.keys(_);f<s.length;f++)l=s[f],h[l]=_[l].map(function(c){return u.landmarks[c]});return[2,[{handInViewConfidence:u.handInViewConfidence,boundingBox:u.boundingBox,landmarks:u.landmarks,annotations:h}]]}})})},r}();const rn={thumb:[0,1,2,3,4],indexFinger:[0,5,6,7,8],middleFinger:[0,9,10,11,12],ringFinger:[0,13,14,15,16],pinky:[0,17,18,19,20]},Wn=()=>{const r=I.exports.useRef(null),t=I.exports.useRef(null),o=I.exports.useRef(),n=I.exports.useCallback(async()=>{const a=o.current,i=r.current,u=t.current,h=u==null?void 0:u.getContext("2d");if(!a||!i||!u||!h)return;const f=await a.estimateHands(i,!0);if(f.length>0){h.clearRect(0,0,u.width,u.height);const s=f[0].landmarks;for(let d=0;d<s.length;d++){const c=s[d][0],p=s[d][1];pn(h,p-2,c-2,3)}const l=Object.keys(rn);for(let d=0;d<l.length;d++){const c=l[d],p=rn[c].map(v=>s[v]);mn(h,p,!1)}}requestAnimationFrame(n)},[]),e=I.exports.useCallback(async()=>{const a=r.current,i=t.current;!a||!i||(vn(a,i,u=>{u.strokeStyle="#ff0000",u.fillStyle="#ff0000"}),o.current=await Hn(),requestAnimationFrame(n))},[n]);return Pn("div",{className:"relative",children:[Q(gn,{ref:r,onLoadedMetadata:e}),Q("canvas",{ref:t,className:"absolute top-0 left-0"})]})};export{Wn as default};
//# sourceMappingURL=HandPose.5620c039.js.map
