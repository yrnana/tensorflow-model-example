import{t as H,d as N,e as M,f as x,g as P,i as O,m as T,h as j,k as E,l as G,n as Q,o as q,T as S,p as X,q as Y,u as $,v as U,w as tt,r as _}from"./vendor.a4162548.js";import{l as I}from"./graph_model.6c4c3382.js";import{s as nt,V as rt}from"./canvas.77fa6c83.js";import{a as et,j as V}from"./index.65c1c8a9.js";/**
    * @license
    * Copyright 2021 Google LLC. All Rights Reserved.
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    * http://www.apache.org/licenses/LICENSE-2.0
    *
    * Unless required by applicable law or agreed to in writing, software
    * distributed under the License is distributed on an "AS IS" BASIS,
    * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    * See the License for the specific language governing permissions and
    * limitations under the License.
    * =============================================================================
    */function B(r,s,e,o){return new(e||(e=Promise))(function(t,i){function a(c){try{l(o.next(c))}catch(n){i(n)}}function u(c){try{l(o.throw(c))}catch(n){i(n)}}function l(c){var n;c.done?t(c.value):(n=c.value,n instanceof e?n:new e(function(h){h(n)})).then(a,u)}l((o=o.apply(r,s||[])).next())})}function D(r,s){var e,o,t,i,a={label:0,sent:function(){if(1&t[0])throw t[1];return t[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(i[Symbol.iterator]=function(){return this}),i;function u(l){return function(c){return function(n){if(e)throw new TypeError("Generator is already executing.");for(;a;)try{if(e=1,o&&(t=2&n[0]?o.return:n[0]?o.throw||((t=o.return)&&t.call(o),0):o.next)&&!(t=t.call(o,n[1])).done)return t;switch(o=0,t&&(n=[2&n[0],t.value]),n[0]){case 0:case 1:t=n;break;case 4:return a.label++,{value:n[1],done:!1};case 5:a.label++,o=n[1],n=[0];continue;case 7:n=a.ops.pop(),a.trys.pop();continue;default:if(!(t=(t=a.trys).length>0&&t[t.length-1])&&(n[0]===6||n[0]===2)){a=0;continue}if(n[0]===3&&(!t||n[1]>t[0]&&n[1]<t[3])){a.label=n[1];break}if(n[0]===6&&a.label<t[1]){a.label=t[1],t=n;break}if(t&&a.label<t[2]){a.label=t[2],a.ops.push(n);break}t[2]&&a.ops.pop(),a.trys.pop();continue}n=s.call(r,a)}catch(h){n=[6,h],o=0}finally{e=t=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([l,c])}}}var ot=function(r){r.startEndTensor.dispose(),r.startPoint.dispose(),r.endPoint.dispose()},K=function(r){return{startEndTensor:r,startPoint:x(r,[0,0],[-1,2]),endPoint:x(r,[0,2],[-1,2])}},at=function(r,s){var e=T(r.startPoint,s),o=T(r.endPoint,s),t=G([e,o],1);return K(t)},st={strides:[8,16],anchors:[2,6]},W=6;function it(r,s,e){for(var o=[],t=0;t<e.strides.length;t++)for(var i=e.strides[t],a=Math.floor((s+i-1)/i),u=Math.floor((r+i-1)/i),l=e.anchors[t],c=0;c<a;c++)for(var n=i*(c+.5),h=0;h<u;h++)for(var p=i*(h+.5),f=0;f<l;f++)o.push([p,n]);return o}function ct(r,s,e){var o=x(r,[0,1],[-1,2]),t=q(o,s),i=x(r,[0,3],[-1,2]),a=M(i,e),u=M(t,e),l=M(a,2),c=j(u,l),n=q(u,l),h=T(c,e),p=T(n,e);return G([h,p],1)}function ut(r){return r instanceof S?[r.shape[0],r.shape[1]]:[r.height,r.width]}function Z(r,s){var e,o,t;if(r.topLeft instanceof S&&r.bottomRight instanceof S){var i=P(function(){return[U([x(j(s-1,r.topLeft),0,1),x(r.topLeft,1,1)]),U([j(s-1,x(r.bottomRight,0,1)),x(r.bottomRight,1,1)])]});e=i[0],o=i[1],r.landmarks!=null&&(t=P(function(){var f=j(N([s-1,0]),r.landmarks),d=N([1,-1]);return T(f,d)}))}else{var a=r.topLeft,u=a[0],l=a[1],c=r.bottomRight,n=c[0],h=c[1];e=[s-1-u,l],o=[s-1-n,h],r.landmarks!=null&&(t=r.landmarks.map(function(f){return[s-1-f[0],f[1]]}))}var p={topLeft:e,bottomRight:o};return t!=null&&(p.landmarks=t),r.probability!=null&&(p.probability=r.probability instanceof S?r.probability.clone():r.probability),p}function J(r,s){return P(function(){var e;return e=r.hasOwnProperty("box")?r.box:r,E(at(e,s).startEndTensor)})}var lt=function(){function r(s,e,o,t,i,a){this.blazeFaceModel=s,this.width=e,this.height=o,this.maxFaces=t,this.anchorsData=it(e,o,st),this.anchors=H(this.anchorsData),this.inputSizeData=[e,o],this.inputSize=N([e,o]),this.iouThreshold=i,this.scoreThreshold=a}return r.prototype.getBoundingBoxes=function(s,e,o){return o===void 0&&(o=!0),B(this,void 0,void 0,function(){var t,i,a,u,l,c,n,h,p,f,d,b,g,y,m=this;return D(this,function(R){switch(R.label){case 0:return t=P(function(){var v=O.resizeBilinear(s,[m.width,m.height]),w=T(j(M(v,255),.5),2),k=m.blazeFaceModel.predict(w),F=E(k),L=ct(F,m.anchors,m.inputSize),z=x(F,[0,0],[-1,1]);return[F,L,E(Q(z))]}),i=t[0],a=t[1],u=t[2],l=console.warn,console.warn=function(){},c=O.nonMaxSuppression(a,u,this.maxFaces,this.iouThreshold,this.scoreThreshold),console.warn=l,[4,c.array()];case 1:return n=R.sent(),c.dispose(),h=n.map(function(v){return x(a,[v,0],[1,-1])}),e?[3,3]:[4,Promise.all(h.map(function(v){return B(m,void 0,void 0,function(){var w;return D(this,function(k){switch(k.label){case 0:return[4,v.array()];case 1:return w=k.sent(),v.dispose(),[2,w]}})})}))];case 2:h=R.sent(),R.label=3;case 3:for(p=s.shape[1],f=s.shape[2],d=e?M([f,p],this.inputSize):[f/this.inputSizeData[0],p/this.inputSizeData[1]],b=[],g=function(v){var w=h[v],k=P(function(){var F=K(w instanceof S?w:H(w));if(!o)return F;var L,z=n[v];return L=e?x(m.anchors,[z,0],[1,2]):m.anchorsData[z],{box:F,landmarks:tt(E(x(i,[z,W-1],[1,-1])),[W,-1]),probability:x(u,[z],[1]),anchor:L}});b.push(k)},y=0;y<h.length;y++)g(y);return a.dispose(),u.dispose(),i.dispose(),[2,{boxes:b,scaleFactor:d}]}})})},r.prototype.estimateFaces=function(s,e,o,t){return e===void 0&&(e=!1),o===void 0&&(o=!1),t===void 0&&(t=!0),B(this,void 0,void 0,function(){var i,a,u,l,c,n,h=this;return D(this,function(p){switch(p.label){case 0:return i=ut(s),a=i[1],u=P(function(){return s instanceof S||(s=X(s)),Y($(s,"float32"),0)}),[4,this.getBoundingBoxes(u,e,t)];case 1:return l=p.sent(),c=l.boxes,n=l.scaleFactor,u.dispose(),e?[2,c.map(function(f){var d=J(f,n),b={topLeft:x(d,[0],[2]),bottomRight:x(d,[2],[2])};if(t){var g=f,y=g.landmarks,m=g.probability,R=g.anchor,v=T(q(y,R),n);b.landmarks=v,b.probability=m}return o&&(b=Z(b,a)),b})]:[2,Promise.all(c.map(function(f){return B(h,void 0,void 0,function(){var d,b,g,y,m,R,v,w,k,F,L,z=this;return D(this,function(A){switch(A.label){case 0:return d=J(f,n),t?[3,2]:[4,d.array()];case 1:return m=A.sent(),b={topLeft:m.slice(0,2),bottomRight:m.slice(2)},[3,4];case 2:return[4,Promise.all([f.landmarks,d,f.probability].map(function(C){return B(z,void 0,void 0,function(){return D(this,function(dt){return[2,C.array()]})})}))];case 3:g=A.sent(),y=g[0],m=g[1],R=g[2],v=f.anchor,k=(w=n)[0],F=w[1],L=y.map(function(C){return[(C[0]+v[0])*k,(C[1]+v[1])*F]}),b={topLeft:m.slice(0,2),bottomRight:m.slice(2),landmarks:L,probability:R},ot(f.box),f.landmarks.dispose(),f.probability.dispose(),A.label=4;case 4:return d.dispose(),o&&(b=Z(b,a)),[2,b]}})})}))]}})})},r}(),ft="https://tfhub.dev/tensorflow/tfjs-model/blazeface/1/default/1";function ht(r){var s=r===void 0?{}:r,e=s.maxFaces,o=e===void 0?10:e,t=s.inputWidth,i=t===void 0?128:t,a=s.inputHeight,u=a===void 0?128:a,l=s.iouThreshold,c=l===void 0?.3:l,n=s.scoreThreshold,h=n===void 0?.75:n,p=s.modelUrl;return B(this,void 0,void 0,function(){var f;return D(this,function(d){switch(d.label){case 0:return p==null?[3,2]:[4,I(p)];case 1:return f=d.sent(),[3,4];case 2:return[4,I(ft,{fromTFHub:!0})];case 3:f=d.sent(),d.label=4;case 4:return[2,new lt(f,i,u,o,c,h)]}})})}const xt=()=>{const r=_.exports.useRef(null),s=_.exports.useRef(null),e=_.exports.useRef(),o=_.exports.useCallback(async()=>{const i=e.current,a=r.current,u=s.current,l=u==null?void 0:u.getContext("2d");if(!i||!a||!u||!l)return;const c=await i.estimateFaces(a,!1,!0,!0);if(c.length>0){l.clearRect(0,0,u.width,u.height);for(let n=0;n<c.length;n++){const h=c[n].topLeft,p=c[n].bottomRight,f=[p[0]-h[0],p[1]-h[1]];l.fillStyle="rgba(255, 0, 0, 0.5)",l.fillRect(h[0],h[1],f[0],f[1]);const d=c[n].landmarks;l.fillStyle="#00ff00";for(let b=0;b<d.length;b++){const g=d[b][0],y=d[b][1];l.fillRect(g,y,5,5)}}}requestAnimationFrame(o)},[]),t=_.exports.useCallback(async()=>{const i=r.current,a=s.current;!i||!a||(nt(i,a),e.current=await ht({maxFaces:1}),requestAnimationFrame(o))},[o]);return et("div",{className:"relative",children:[V(rt,{ref:r,onLoadedMetadata:t}),V("canvas",{ref:s,className:"absolute top-0 left-0"})]})};export{xt as default};
//# sourceMappingURL=FaceDetection.6f8e71f4.js.map
